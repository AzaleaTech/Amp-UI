"use strict";var ctx,_wxCanvas=_interopRequireDefault(require("./wx-canvas")),echarts=_interopRequireWildcard(require("./echarts"));function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,a=new WeakMap;return(_getRequireWildcardCache=function(e){return e?a:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var a,n,r={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&((n=c?Object.getOwnPropertyDescriptor(e,a):null)&&(n.get||n.set)?Object.defineProperty(r,a,n):r[a]=e[a]);return r.default=e,t&&t.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function compareVersion(e,t){e=e.split("."),t=t.split(".");for(var a=Math.max(e.length,t.length);e.length<a;)e.push("0");for(;t.length<a;)t.push("0");for(var n=0;n<a;n++){var r=parseInt(e[n]),c=parseInt(t[n]);if(c<r)return 1;if(r<c)return-1}return 0}function wrapTouch(e){for(var t=0;t<e.touches.length;++t){var a=e.touches[t];a.offsetX=a.x,a.offsetY=a.y}return e}Component({properties:{canvasId:{type:String,value:"ec-canvas"},ec:{type:Object},forceUseOldCanvas:{type:Boolean,value:!1}},data:{isUseNewCanvas:!1},ready:function(){echarts.registerPreprocessor(function(e){e&&e.series&&(0<e.series.length?e.series.forEach(function(e){e.progressive=0}):"object"===_typeof(e.series)&&(e.series.progressive=0))}),this.data.ec?this.data.ec.lazyLoad||this.init():console.warn('组件需绑定 ec 变量，例：<ec-canvas id="mychart-dom-bar" canvas-id="mychart-bar" ec="{{ ec }}"></ec-canvas>')},methods:{init:function(e){var t=wx.getSystemInfoSync().SDKVersion,a=0<=compareVersion(t,"2.9.0"),n=this.data.forceUseOldCanvas,r=a&&!n;this.setData({isUseNewCanvas:r}),n&&a&&console.warn("开发者强制使用旧canvas,建议关闭"),r?this.initByNewWay(e):0<=compareVersion(t,"1.9.91")?(console.warn("建议将微信基础库调整大于等于2.9.0版本。升级后绘图将有更好性能"),this.initByOldWay(e)):console.error("微信基础库版本过低，需大于等于 1.9.91。参见：https://github.com/ecomfe/echarts-for-weixin#%E5%BE%AE%E4%BF%A1%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82")},initByOldWay:function(t){var a=this;ctx=wx.createCanvasContext(this.data.canvasId,this);var n=new _wxCanvas.default(ctx,this.data.canvasId,!1);echarts.setCanvasCreator(function(){return n});wx.createSelectorQuery().in(this).select(".ec-canvas").boundingClientRect(function(e){"function"==typeof t?a.chart=t(n,e.width,e.height,1):a.data.ec&&"function"==typeof a.data.ec.onInit?a.chart=a.data.ec.onInit(n,e.width,e.height,1):a.triggerEvent("init",{canvas:n,width:e.width,height:e.height,canvasDpr:1})}).exec()},initByNewWay:function(o){var i=this;wx.createSelectorQuery().in(this).select(".ec-canvas").fields({node:!0,size:!0}).exec(function(e){var t=e[0].node;i.canvasNode=t;var a=wx.getSystemInfoSync().pixelRatio,n=e[0].width,r=e[0].height,e=t.getContext("2d"),c=new _wxCanvas.default(e,i.data.canvasId,!0,t);echarts.setCanvasCreator(function(){return c}),"function"==typeof o?i.chart=o(c,n,r,a):i.data.ec&&"function"==typeof i.data.ec.onInit?i.chart=i.data.ec.onInit(c,n,r,a):i.triggerEvent("init",{canvas:c,width:n,height:r,dpr:a})})},canvasToTempFilePath:function(t){var e=this;this.data.isUseNewCanvas?wx.createSelectorQuery().in(this).select(".ec-canvas").fields({node:!0,size:!0}).exec(function(e){e=e[0].node;t.canvas=e,wx.canvasToTempFilePath(t)}):(t.canvasId||(t.canvasId=this.data.canvasId),ctx.draw(!0,function(){wx.canvasToTempFilePath(t,e)}))},touchStart:function(e){var t,a;this.chart&&0<e.touches.length&&(t=e.touches[0],(a=this.chart.getZr().handler).dispatch("mousedown",{zrX:t.x,zrY:t.y}),a.dispatch("mousemove",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"start"))},touchMove:function(e){var t,a;this.chart&&0<e.touches.length&&(t=e.touches[0],(a=this.chart.getZr().handler).dispatch("mousemove",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"change"))},touchEnd:function(e){var t,a;this.chart&&(t=e.changedTouches?e.changedTouches[0]:{},(a=this.chart.getZr().handler).dispatch("mouseup",{zrX:t.x,zrY:t.y}),a.dispatch("click",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"end"))}}});